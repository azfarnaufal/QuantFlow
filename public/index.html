<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Price Tracker Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        select, button, input {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .price-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .price-card h3 {
            margin-top: 0;
            color: #333;
        }
        .price-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .volume-value {
            font-size: 14px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
        .alert-form {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert-form h2 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-col {
            flex: 1;
        }
        .channel-checkboxes {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .channel-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .alerts-list {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .alert-item:last-child {
            border-bottom: none;
        }
        .alert-details {
            flex: 1;
        }
        .alert-type {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .alert-condition {
            font-size: 14px;
            color: #666;
        }
        .alert-channels {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
        .alert-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .alert-status.active {
            background-color: #d4edda;
            color: #155724;
        }
        .alert-status.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        .delete-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .reports-form {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .indicators-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .indicator-card {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .indicator-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .indicator-value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        .predictions-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .prediction-card {
            background-color: #e8f5e9;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .prediction-title {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .prediction-value {
            font-size: 18px;
            font-weight: bold;
            color: #2e7d32;
        }
        .future-predictions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .future-prediction-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        .watchlist-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .watchlist-controls {
            display: flex;
            gap: 10px;
        }
        .watchlist-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .watchlist-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .watchlist-item-symbol {
            font-weight: bold;
        }
        .watchlist-item-price {
            color: #007bff;
        }
        .remove-watchlist-item {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .comparison-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .comparison-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .comparison-chart-container {
            height: 400px;
            margin-top: 20px;
        }
        .volume-chart-container {
            height: 300px;
            margin-top: 20px;
        }
        .market-overview {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .market-item {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .market-symbol {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .market-price {
            font-size: 18px;
            color: #007bff;
            margin-bottom: 5px;
        }
        .market-change {
            font-size: 14px;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Crypto Price Tracker Dashboard</h1>
        
        <div class="controls">
            <select id="symbolSelect">
                <option value="">Select a symbol</option>
            </select>
            <select id="intervalSelect">
                <option value="1 min">1 Minute</option>
                <option value="5 min">5 Minutes</option>
                <option value="15 min">15 Minutes</option>
                <option value="30 min">30 Minutes</option>
                <option value="1 hour" selected>1 Hour</option>
                <option value="4 hour">4 Hours</option>
                <option value="1 day">1 Day</option>
            </select>
            <select id="hoursSelect">
                <option value="1">1 Hour</option>
                <option value="6">6 Hours</option>
                <option value="12">12 Hours</option>
                <option value="24" selected>24 Hours</option>
                <option value="48">48 Hours</option>
                <option value="72">72 Hours</option>
                <option value="168">1 Week</option>
            </select>
            <button id="refreshBtn">Refresh Data</button>
        </div>
        
        <div class="price-grid" id="priceGrid">
            <div class="loading">Loading price data...</div>
        </div>
        
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        
        <div class="alert-form">
            <h2>Set Price Alert</h2>
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="alertSymbol">Symbol:</label>
                        <select id="alertSymbol"></select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="alertType">Condition:</label>
                        <select id="alertType">
                            <option value="above">Price Above</option>
                            <option value="below">Price Below</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="alertThreshold">Threshold ($):</label>
                        <input type="number" id="alertThreshold" step="0.01" placeholder="Enter threshold price">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Notification Channels:</label>
                <div class="channel-checkboxes">
                    <div class="channel-checkbox">
                        <input type="checkbox" id="channelTelegram" value="telegram" checked>
                        <label for="channelTelegram">Telegram</label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="channelEmail" value="email">
                        <label for="channelEmail">Email</label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="channelDiscord" value="discord">
                        <label for="channelDiscord">Discord</label>
                    </div>
                </div>
            </div>
            <button id="addAlertBtn">Add Price Alert</button>
        </div>
        
        <div class="alert-form">
            <h2>Set Indicator Alert</h2>
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="indicatorAlertSymbol">Symbol:</label>
                        <select id="indicatorAlertSymbol"></select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="indicatorType">Indicator:</label>
                        <select id="indicatorType">
                            <option value="rsi">RSI</option>
                            <option value="sma">SMA</option>
                            <option value="ema">EMA</option>
                            <option value="macd">MACD</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="indicatorCondition">Condition:</label>
                        <select id="indicatorCondition">
                            <option value="above">Crossing Above</option>
                            <option value="below">Crossing Below</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="indicatorThreshold">Threshold:</label>
                        <input type="number" id="indicatorThreshold" step="0.1" placeholder="Enter threshold">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Notification Channels:</label>
                <div class="channel-checkboxes">
                    <div class="channel-checkbox">
                        <input type="checkbox" id="indicatorChannelTelegram" value="telegram" checked>
                        <label for="indicatorChannelTelegram">Telegram</label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="indicatorChannelEmail" value="email">
                        <label for="indicatorChannelEmail">Email</label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="indicatorChannelDiscord" value="discord">
                        <label for="indicatorChannelDiscord">Discord</label>
                    </div>
                </div>
            </div>
            <button id="addIndicatorAlertBtn">Add Indicator Alert</button>
        </div>
        
        <div class="reports-form">
            <h2>Scheduled Reports</h2>
            <div class="form-row">
                <div class="form-col">
                    <div class="form-group">
                        <label for="reportEnabled">
                            <input type="checkbox" id="reportEnabled"> Enable Scheduled Reports
                        </label>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="reportFrequency">Frequency:</label>
                        <select id="reportFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="reportTime">Time:</label>
                        <input type="time" id="reportTime" value="09:00">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Notification Channels:</label>
                <div class="channel-checkboxes">
                    <div class="channel-checkbox">
                        <input type="checkbox" id="reportChannelTelegram" value="telegram">
                        <label for="reportChannelTelegram">Telegram</label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="reportChannelEmail" value="email" checked>
                        <label for="reportChannelEmail">Email</label>
                    </div>
                    <div class="channel-checkbox">
                        <input type="checkbox" id="reportChannelDiscord" value="discord">
                        <label for="reportChannelDiscord">Discord</label>
                    </div>
                </div>
            </div>
            <button id="saveReportsBtn">Save Report Settings</button>
        </div>
        
        <div class="alerts-list">
            <h2>Active Alerts</h2>
            <div id="alertsList">
                <div class="loading">Loading alerts...</div>
            </div>
        </div>
        
        <div class="indicators-container">
            <h2>Technical Indicators</h2>
            <div class="controls">
                <select id="indicatorSymbolSelect">
                    <option value="">Select a symbol</option>
                </select>
                <button id="loadIndicatorsBtn">Load Indicators</button>
            </div>
            <div class="indicators-grid" id="indicatorsGrid">
                <div class="loading">Select a symbol and click "Load Indicators"</div>
            </div>
        </div>
        
        <div class="predictions-container">
            <h2>Price Predictions</h2>
            <div class="controls">
                <select id="predictionSymbolSelect">
                    <option value="">Select a symbol</option>
                </select>
                <button id="loadPredictionsBtn">Load Predictions</button>
            </div>
            <div class="predictions-grid" id="predictionsGrid">
                <div class="loading">Select a symbol and click "Load Predictions"</div>
            </div>
            <div class="future-predictions" id="futurePredictions">
            </div>
        </div>
        
        <div class="watchlist-container">
            <div class="watchlist-header">
                <h2>Watchlist</h2>
                <div class="watchlist-controls">
                    <select id="availableSymbols">
                        <option value="">Select symbol to add</option>
                    </select>
                    <button id="addToWatchlistBtn">Add to Watchlist</button>
                </div>
            </div>
            <div class="watchlist-items" id="watchlistItems">
                <div class="loading">Loading watchlist...</div>
            </div>
        </div>
        
        <div class="comparison-container">
            <h2>Symbol Comparison</h2>
            <div class="comparison-controls">
                <select id="compareSymbol1">
                    <option value="">Select first symbol</option>
                </select>
                <select id="compareSymbol2">
                    <option value="">Select second symbol</option>
                </select>
                <select id="compareSymbol3">
                    <option value="">Select third symbol (optional)</option>
                </select>
                <button id="compareSymbolsBtn">Compare Symbols</button>
            </div>
            <div class="comparison-chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        
        <div class="market-overview">
            <h2>Market Overview</h2>
            <div class="controls">
                <button id="loadMarketOverviewBtn">Load Market Overview</button>
            </div>
            <div class="market-grid" id="marketOverviewGrid">
                <div class="loading">Click "Load Market Overview" to see market data</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let priceChart = null;
        let symbols = [];
        
        // DOM elements
        const symbolSelect = document.getElementById('symbolSelect');
        const intervalSelect = document.getElementById('intervalSelect');
        const hoursSelect = document.getElementById('hoursSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const priceGrid = document.getElementById('priceGrid');
        
        // Indicator elements
        const indicatorSymbolSelect = document.getElementById('indicatorSymbolSelect');
        const loadIndicatorsBtn = document.getElementById('loadIndicatorsBtn');
        const indicatorsGrid = document.getElementById('indicatorsGrid');
        
        // Prediction elements
        const predictionSymbolSelect = document.getElementById('predictionSymbolSelect');
        const loadPredictionsBtn = document.getElementById('loadPredictionsBtn');
        const predictionsGrid = document.getElementById('predictionsGrid');
        const futurePredictions = document.getElementById('futurePredictions');
        
        // Watchlist elements
        const availableSymbols = document.getElementById('availableSymbols');
        const addToWatchlistBtn = document.getElementById('addToWatchlistBtn');
        const watchlistItems = document.getElementById('watchlistItems');
        
        // Comparison elements
        const compareSymbol1 = document.getElementById('compareSymbol1');
        const compareSymbol2 = document.getElementById('compareSymbol2');
        const compareSymbol3 = document.getElementById('compareSymbol3');
        const compareSymbolsBtn = document.getElementById('compareSymbolsBtn');
        let comparisonChart = null;
        
        // Market overview elements
        const loadMarketOverviewBtn = document.getElementById('loadMarketOverviewBtn');
        const marketOverviewGrid = document.getElementById('marketOverviewGrid');
        
        // Alert elements
        const alertSymbol = document.getElementById('alertSymbol');
        const alertType = document.getElementById('alertType');
        const alertThreshold = document.getElementById('alertThreshold');
        const addAlertBtn = document.getElementById('addAlertBtn');
        
        // Indicator alert elements
        const indicatorAlertSymbol = document.getElementById('indicatorAlertSymbol');
        const indicatorType = document.getElementById('indicatorType');
        const indicatorCondition = document.getElementById('indicatorCondition');
        const indicatorThreshold = document.getElementById('indicatorThreshold');
        const addIndicatorAlertBtn = document.getElementById('addIndicatorAlertBtn');
        
        // Report elements
        const reportEnabled = document.getElementById('reportEnabled');
        const reportFrequency = document.getElementById('reportFrequency');
        const reportTime = document.getElementById('reportTime');
        const saveReportsBtn = document.getElementById('saveReportsBtn');
        
        const alertsList = document.getElementById('alertsList');
        
        // Initialize the dashboard
        async function initDashboard() {
            try {
                // Load available symbols
                await loadSymbols();
                
                // Load initial price data
                await loadPriceData();
                
                // Load alerts and reports
                await loadAlerts();
                await loadReportsConfig();
                
                // Load watchlist
                await loadWatchlist();
                
                // Set up event listeners
                symbolSelect.addEventListener('change', loadChartData);
                intervalSelect.addEventListener('change', loadChartData);
                hoursSelect.addEventListener('change', loadChartData);
                refreshBtn.addEventListener('click', refreshData);
                
                // Indicator event listeners
                loadIndicatorsBtn.addEventListener('click', loadIndicators);
                
                // Prediction event listeners
                loadPredictionsBtn.addEventListener('click', loadPredictions);
                
                // Watchlist event listeners
                addToWatchlistBtn.addEventListener('click', addToWatchlist);
                
                // Comparison event listeners
                compareSymbolsBtn.addEventListener('click', compareSymbols);
                
                // Market overview event listeners
                loadMarketOverviewBtn.addEventListener('click', loadMarketOverview);
                
                // Alert event listeners
                addAlertBtn.addEventListener('click', addAlert);
                addIndicatorAlertBtn.addEventListener('click', addIndicatorAlert);
                
                // Report event listeners
                saveReportsBtn.addEventListener('click', saveReportsConfig);
                
                // Load chart data for the first symbol
                if (symbols.length > 0) {
                    symbolSelect.value = symbols[0];
                    alertSymbol.value = symbols[0];
                    indicatorAlertSymbol.value = symbols[0];
                    predictionSymbolSelect.value = symbols[0];
                    compareSymbol1.value = symbols[0];
                    if (symbols.length > 1) {
                        compareSymbol2.value = symbols[1];
                    }
                    await loadChartData();
                }
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                priceGrid.innerHTML = '<div class="loading">Error loading data. Please try again.</div>';
            }
        }
        
        // Load available symbols
        async function loadSymbols() {
            try {
                const response = await fetch('/symbols');
                const data = await response.json();
                symbols = data.symbols;
                
                // Populate symbol select dropdowns
                symbolSelect.innerHTML = '<option value="">Select a symbol</option>';
                alertSymbol.innerHTML = '<option value="">Select a symbol</option>';
                indicatorAlertSymbol.innerHTML = '<option value="">Select a symbol</option>';
                indicatorSymbolSelect.innerHTML = '<option value="">Select a symbol</option>';
                predictionSymbolSelect.innerHTML = '<option value="">Select a symbol</option>';
                availableSymbols.innerHTML = '<option value="">Select symbol to add</option>';
                compareSymbol1.innerHTML = '<option value="">Select first symbol</option>';
                compareSymbol2.innerHTML = '<option value="">Select second symbol</option>';
                compareSymbol3.innerHTML = '<option value="">Select third symbol (optional)</option>';
                
                symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    
                    symbolSelect.appendChild(option.cloneNode(true));
                    alertSymbol.appendChild(option.cloneNode(true));
                    indicatorAlertSymbol.appendChild(option.cloneNode(true));
                    indicatorSymbolSelect.appendChild(option.cloneNode(true));
                    predictionSymbolSelect.appendChild(option.cloneNode(true));
                    availableSymbols.appendChild(option.cloneNode(true));
                    compareSymbol1.appendChild(option.cloneNode(true));
                    compareSymbol2.appendChild(option.cloneNode(true));
                    compareSymbol3.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                console.error('Error loading symbols:', error);
            }
        }
        
        // Load current price data
        async function loadPriceData() {
            try {
                const response = await fetch('/prices');
                const data = await response.json();
                
                // Create price cards
                let html = '';
                for (const [symbol, priceData] of Object.entries(data)) {
                    html += `
                        <div class="price-card">
                            <h3>${symbol}</h3>
                            <div class="price-value">$${parseFloat(priceData.price).toFixed(2)}</div>
                            <div class="volume-value">Volume: ${parseFloat(priceData.volume).toLocaleString()}</div>
                        </div>
                    `;
                }
                
                priceGrid.innerHTML = html;
            } catch (error) {
                console.error('Error loading price data:', error);
                priceGrid.innerHTML = '<div class="loading">Error loading price data. Please try again.</div>';
            }
        }
        
        // Load chart data
        async function loadChartData() {
            const symbol = symbolSelect.value;
            const interval = intervalSelect.value;
            const hours = hoursSelect.value;
            
            if (!symbol) {
                return;
            }
            
            try {
                const response = await fetch(`/ohlc/${symbol}?interval=${encodeURIComponent(interval)}&hours=${hours}`);
                const data = await response.json();
                
                // Prepare chart data
                const chartData = {
                    labels: data.data.map(item => new Date(item.bucket).toLocaleString()),
                    datasets: [{
                        label: `${symbol} Price`,
                        data: data.data.map(item => parseFloat(item.close)),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: false
                    }]
                };
                
                // Create or update chart
                if (priceChart) {
                    priceChart.data.labels = chartData.labels;
                    priceChart.data.datasets[0].data = chartData.datasets[0].data;
                    priceChart.data.datasets[0].label = chartData.datasets[0].label;
                    priceChart.update();
                } else {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    priceChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }
        
        // Refresh all data
        async function refreshData() {
            await loadPriceData();
            await loadChartData();
            await loadAlerts();
        }
        
        // Load alerts
        async function loadAlerts() {
            try {
                const response = await fetch('/alerts');
                const data = await response.json();
                
                let html = '';
                if (data.alerts.length === 0) {
                    html = '<div>No alerts configured</div>';
                } else {
                    data.alerts.forEach(alert => {
                        const statusClass = alert.enabled ? 'active' : 'inactive';
                        const statusText = alert.enabled ? 'Active' : 'Inactive';
                        
                        let alertTypeText = '';
                        let alertConditionText = '';
                        
                        if (alert.type === 'indicator') {
                            alertTypeText = `${alert.indicator.toUpperCase()} Alert`;
                            alertConditionText = `${alert.condition} ${alert.threshold}`;
                        } else {
                            alertTypeText = 'Price Alert';
                            alertConditionText = `${alert.type} $${alert.threshold}`;
                        }
                        
                        const channelsText = alert.channels ? alert.channels.join(', ') : 'telegram';
                        
                        html += `
                            <div class="alert-item">
                                <div class="alert-details">
                                    <div class="alert-type">${alert.symbol} - ${alertTypeText}</div>
                                    <div class="alert-condition">${alertConditionText}</div>
                                    <div class="alert-channels">Channels: ${channelsText}</div>
                                </div>
                                <div>
                                    <span class="alert-status ${statusClass}">${statusText}</span>
                                    <button class="delete-btn" onclick="deleteAlert('${alert.symbol}', '${alert.type}', ${alert.threshold}, '${alert.indicator || ''}', '${alert.condition || ''}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                alertsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading alerts:', error);
                alertsList.innerHTML = '<div class="loading">Error loading alerts. Please try again.</div>';
            }
        }
        
        // Load reports configuration
        async function loadReportsConfig() {
            try {
                const response = await fetch('/alerts/reports');
                const data = await response.json();
                
                const reports = data.scheduledReports;
                if (reports) {
                    reportEnabled.checked = reports.enabled || false;
                    reportFrequency.value = reports.frequency || 'daily';
                    reportTime.value = reports.time || '09:00';
                    
                    // Reset checkboxes
                    document.getElementById('reportChannelTelegram').checked = false;
                    document.getElementById('reportChannelEmail').checked = false;
                    document.getElementById('reportChannelDiscord').checked = false;
                    
                    // Check channels
                    if (reports.channels) {
                        reports.channels.forEach(channel => {
                            const checkbox = document.getElementById(`reportChannel${channel.charAt(0).toUpperCase() + channel.slice(1)}`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading reports config:', error);
            }
        }
        
        // Add new price alert
        async function addAlert() {
            const symbol = alertSymbol.value;
            const type = alertType.value;
            const threshold = parseFloat(alertThreshold.value);
            
            // Get selected channels
            const channels = [];
            if (document.getElementById('channelTelegram').checked) channels.push('telegram');
            if (document.getElementById('channelEmail').checked) channels.push('email');
            if (document.getElementById('channelDiscord').checked) channels.push('discord');
            
            if (!symbol || !type || isNaN(threshold)) {
                alert('Please fill in all fields correctly');
                return;
            }
            
            try {
                const response = await fetch('/alerts/price', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, type, threshold, channels })
                });
                
                if (response.ok) {
                    alert('Price alert added successfully');
                    alertThreshold.value = '';
                    await loadAlerts();
                } else {
                    const error = await response.json();
                    alert('Error adding alert: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding alert:', error);
                alert('Error adding alert. Please try again.');
            }
        }
        
        // Add new indicator alert
        async function addIndicatorAlert() {
            const symbol = indicatorAlertSymbol.value;
            const indicator = indicatorType.value;
            const condition = indicatorCondition.value;
            const threshold = parseFloat(indicatorThreshold.value);
            
            // Get selected channels
            const channels = [];
            if (document.getElementById('indicatorChannelTelegram').checked) channels.push('telegram');
            if (document.getElementById('indicatorChannelEmail').checked) channels.push('email');
            if (document.getElementById('indicatorChannelDiscord').checked) channels.push('discord');
            
            if (!symbol || !indicator || !condition || isNaN(threshold)) {
                alert('Please fill in all fields correctly');
                return;
            }
            
            try {
                const response = await fetch('/alerts/indicator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol, indicator, condition, threshold, channels })
                });
                
                if (response.ok) {
                    alert('Indicator alert added successfully');
                    indicatorThreshold.value = '';
                    await loadAlerts();
                } else {
                    const error = await response.json();
                    alert('Error adding indicator alert: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding indicator alert:', error);
                alert('Error adding indicator alert. Please try again.');
            }
        }
        
        // Save reports configuration
        async function saveReportsConfig() {
            const enabled = reportEnabled.checked;
            const frequency = reportFrequency.value;
            const time = reportTime.value;
            
            // Get selected channels
            const channels = [];
            if (document.getElementById('reportChannelTelegram').checked) channels.push('telegram');
            if (document.getElementById('reportChannelEmail').checked) channels.push('email');
            if (document.getElementById('reportChannelDiscord').checked) channels.push('discord');
            
            try {
                const response = await fetch('/alerts/reports', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled, frequency, time, channels })
                });
                
                if (response.ok) {
                    alert('Report settings saved successfully');
                    await loadReportsConfig();
                } else {
                    const error = await response.json();
                    alert('Error saving report settings: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving report settings:', error);
                alert('Error saving report settings. Please try again.');
            }
        }
        
        // Delete alert
        async function deleteAlert(symbol, type, threshold, indicator, condition) {
            if (!confirm('Are you sure you want to delete this alert?')) {
                return;
            }
            
            // Build URL with optional parameters
            let url = `/alerts/${symbol}/${type}/${threshold}`;
            if (indicator) url += `/${indicator}`;
            if (condition) url += `/${condition}`;
            
            try {
                const response = await fetch(url, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Alert deleted successfully');
                    await loadAlerts();
                } else {
                    const error = await response.json();
                    alert('Error deleting alert: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting alert:', error);
                alert('Error deleting alert. Please try again.');
            }
        }
        
        // Make deleteAlert available globally for onclick
        window.deleteAlert = deleteAlert;
        
        // Load indicators
        async function loadIndicators() {
            const symbol = indicatorSymbolSelect.value;
            
            if (!symbol) {
                alert('Please select a symbol');
                return;
            }
            
            try {
                indicatorsGrid.innerHTML = '<div class="loading">Loading indicators...</div>';
                
                const response = await fetch(`/indicators/${symbol}`);
                const data = await response.json();
                
                if (!response.ok) {
                    indicatorsGrid.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                const indicators = data.indicators;
                
                // Create indicators display
                let html = '';
                
                // Add SMA indicators
                if (indicators.sma20 !== null) {
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">SMA (20)</div>
                            <div class="indicator-value">$${indicators.sma20.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                if (indicators.sma50 !== null) {
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">SMA (50)</div>
                            <div class="indicator-value">$${indicators.sma50.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                // Add EMA indicators
                if (indicators.ema12 !== null) {
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">EMA (12)</div>
                            <div class="indicator-value">$${indicators.ema12.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                if (indicators.ema26 !== null) {
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">EMA (26)</div>
                            <div class="indicator-value">$${indicators.ema26.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                // Add RSI
                if (indicators.rsi14 !== null) {
                    const rsiValue = indicators.rsi14.toFixed(2);
                    const rsiColor = rsiValue > 70 ? '#dc3545' : rsiValue < 30 ? '#28a745' : '#007bff';
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">RSI (14)</div>
                            <div class="indicator-value" style="color: ${rsiColor}">${rsiValue}</div>
                        </div>
                    `;
                }
                
                // Add MACD
                if (indicators.macd !== null) {
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">MACD</div>
                            <div class="indicator-value">$${indicators.macd.macdLine.toFixed(2)}</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">MACD Signal</div>
                            <div class="indicator-value">$${indicators.macd.signalLine.toFixed(2)}</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">MACD Histogram</div>
                            <div class="indicator-value" style="color: ${indicators.macd.histogram >= 0 ? '#28a745' : '#dc3545'}">
                                ${indicators.macd.histogram.toFixed(2)}
                            </div>
                        </div>
                    `;
                }
                
                // Add Bollinger Bands
                if (indicators.bollingerBands !== null) {
                    html += `
                        <div class="indicator-card">
                            <div class="indicator-name">BB Upper</div>
                            <div class="indicator-value">$${indicators.bollingerBands.upper.toFixed(2)}</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">BB Middle</div>
                            <div class="indicator-value">$${indicators.bollingerBands.middle.toFixed(2)}</div>
                        </div>
                        <div class="indicator-card">
                            <div class="indicator-name">BB Lower</div>
                            <div class="indicator-value">$${indicators.bollingerBands.lower.toFixed(2)}</div>
                        </div>
                    `;
                }
                
                if (html === '') {
                    html = '<div class="loading">No indicators available</div>';
                }
                
                indicatorsGrid.innerHTML = html;
            } catch (error) {
                console.error('Error loading indicators:', error);
                indicatorsGrid.innerHTML = '<div class="loading">Error loading indicators. Please try again.</div>';
            }
        }
        
        // Load predictions
        async function loadPredictions() {
            const symbol = predictionSymbolSelect.value;
            
            if (!symbol) {
                alert('Please select a symbol');
                return;
            }
            
            try {
                predictionsGrid.innerHTML = '<div class="loading">Loading predictions...</div>';
                futurePredictions.innerHTML = '';
                
                const response = await fetch(`/predict/${symbol}`);
                const data = await response.json();
                
                if (!response.ok) {
                    predictionsGrid.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                const prediction = data.prediction;
                const futurePredictionsData = data.futurePredictions;
                const currentPrice = data.currentPrice;
                
                // Create predictions display
                let html = '';
                
                // Add ensemble prediction
                html += `
                    <div class="prediction-card">
                        <div class="prediction-title">Ensemble Prediction</div>
                        <div class="prediction-value">$${prediction.ensemble}</div>
                    </div>
                `;
                
                // Add individual predictions
                html += `
                    <div class="prediction-card">
                        <div class="prediction-title">Linear Regression</div>
                        <div class="prediction-value">$${prediction.linearRegression}</div>
                    </div>
                    <div class="prediction-card">
                        <div class="prediction-title">Moving Average</div>
                        <div class="prediction-value">$${prediction.simpleMovingAverage}</div>
                    </div>
                    <div class="prediction-card">
                        <div class="prediction-title">Exp. Smoothing</div>
                        <div class="prediction-value">$${prediction.exponentialSmoothing}</div>
                    </div>
                    <div class="prediction-card">
                        <div class="prediction-title">Current Price</div>
                        <div class="prediction-value">$${currentPrice.toFixed(2)}</div>
                    </div>
                `;
                
                predictionsGrid.innerHTML = html;
                
                // Display future predictions
                if (futurePredictionsData && futurePredictionsData.length > 0) {
                    let futureHtml = '<h3>Future Predictions</h3>';
                    futurePredictionsData.forEach((pred, i) => {
                        const change = ((pred - currentPrice) / currentPrice * 100).toFixed(2);
                        const changeColor = change >= 0 ? '#28a745' : '#dc3545';
                        futureHtml += `
                            <div class="future-prediction-item">
                                <span>Step ${i + 1}:</span>
                                <span>
                                    <strong>$${pred.toFixed(2)}</strong>
                                    <span style="color: ${changeColor};"> (${change}%)</span>
                                </span>
                            </div>
                        `;
                    });
                    futurePredictions.innerHTML = futureHtml;
                }
            } catch (error) {
                console.error('Error loading predictions:', error);
                predictionsGrid.innerHTML = '<div class="loading">Error loading predictions. Please try again.</div>';
            }
        }
        
        // Load watchlist
        async function loadWatchlist() {
            try {
                const response = await fetch('/watchlists/default');
                const data = await response.json();
                
                let html = '';
                if (data.symbols.length === 0) {
                    html = '<div>No symbols in watchlist</div>';
                } else {
                    // Get current prices for watchlist symbols
                    const pricesResponse = await fetch('/prices');
                    const pricesData = await pricesResponse.json();
                    
                    data.symbols.forEach(symbol => {
                        const priceData = pricesData[symbol];
                        const price = priceData ? priceData.price : 'N/A';
                        html += `
                            <div class="watchlist-item">
                                <div>
                                    <div class="watchlist-item-symbol">${symbol}</div>
                                    <div class="watchlist-item-price">$${price}</div>
                                </div>
                                <button class="remove-watchlist-item" onclick="removeFromWatchlist('${symbol}')">Remove</button>
                            </div>
                        `;
                    });
                }
                
                watchlistItems.innerHTML = html;
            } catch (error) {
                console.error('Error loading watchlist:', error);
                watchlistItems.innerHTML = '<div class="loading">Error loading watchlist. Please try again.</div>';
            }
        }
        
        // Add symbol to watchlist
        async function addToWatchlist() {
            const symbol = availableSymbols.value;
            
            if (!symbol) {
                alert('Please select a symbol to add');
                return;
            }
            
            try {
                const response = await fetch('/watchlists/default/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol })
                });
                
                if (response.ok) {
                    await loadWatchlist();
                } else {
                    const error = await response.json();
                    alert('Error adding to watchlist: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('Error adding to watchlist. Please try again.');
            }
        }
        
        // Remove symbol from watchlist
        async function removeFromWatchlist(symbol) {
            try {
                const response = await fetch('/watchlists/default/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbol })
                });
                
                if (response.ok) {
                    await loadWatchlist();
                } else {
                    const error = await response.json();
                    alert('Error removing from watchlist: ' + error.error);
                }
            } catch (error) {
                console.error('Error removing from watchlist:', error);
                alert('Error removing from watchlist. Please try again.');
            }
        }
        
        // Compare symbols
        async function compareSymbols() {
            const symbol1 = compareSymbol1.value;
            const symbol2 = compareSymbol2.value;
            const symbol3 = compareSymbol3.value;
            
            if (!symbol1 || !symbol2) {
                alert('Please select at least two symbols to compare');
                return;
            }
            
            const symbols = [symbol1, symbol2];
            if (symbol3) {
                symbols.push(symbol3);
            }
            
            try {
                const response = await fetch(`/compare?symbols=${symbols.join(',')}`);
                const data = await response.json();
                
                if (!response.ok) {
                    alert('Error comparing symbols: ' + data.error);
                    return;
                }
                
                // Prepare chart data
                const datasets = [];
                const allTimes = new Set();
                
                // Collect all time points
                for (const [symbol, symbolData] of Object.entries(data.data)) {
                    symbolData.history.forEach(item => {
                        allTimes.add(new Date(item.time).getTime());
                    });
                }
                
                const sortedTimes = Array.from(allTimes).sort();
                const labels = sortedTimes.map(time => new Date(time).toLocaleString());
                
                // Create datasets for each symbol
                for (const [symbol, symbolData] of Object.entries(data.data)) {
                    const priceMap = {};
                    symbolData.history.forEach(item => {
                        priceMap[new Date(item.time).getTime()] = item.price;
                    });
                    
                    const prices = sortedTimes.map(time => priceMap[time] || null);
                    
                    datasets.push({
                        label: symbol,
                        data: prices,
                        borderColor: getRandomColor(),
                        backgroundColor: 'rgba(0, 0, 0, 0)',
                        tension: 0.1,
                        fill: false
                    });
                }
                
                // Create or update chart
                const chartData = {
                    labels: labels,
                    datasets: datasets
                };
                
                if (comparisonChart) {
                    comparisonChart.data.labels = chartData.labels;
                    comparisonChart.data.datasets = chartData.datasets;
                    comparisonChart.update();
                } else {
                    const ctx = document.getElementById('comparisonChart').getContext('2d');
                    comparisonChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error comparing symbols:', error);
                alert('Error comparing symbols. Please try again.');
            }
        }
        
        // Generate random color for chart lines
        function getRandomColor() {
            const colors = [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)',
                'rgb(153, 102, 255)',
                'rgb(255, 159, 64)'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Load market overview
        async function loadMarketOverview() {
            try {
                marketOverviewGrid.innerHTML = '<div class="loading">Loading market overview...</div>';
                
                const response = await fetch('/market/overview');
                const data = await response.json();
                
                if (!response.ok) {
                    marketOverviewGrid.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                const marketData = data.marketData;
                
                // Create market overview display
                let html = '';
                
                for (const [symbol, symbolData] of Object.entries(marketData)) {
                    const changePercent = ((symbolData.price - (symbolData.price * 0.99)) / (symbolData.price * 0.99) * 100).toFixed(2);
                    const isPositive = changePercent >= 0;
                    
                    html += `
                        <div class="market-item">
                            <div class="market-symbol">${symbol}</div>
                            <div class="market-price">$${symbolData.price.toFixed(2)}</div>
                            <div class="market-change ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : ''}${changePercent}%
                            </div>
                        </div>
                    `;
                }
                
                if (html === '') {
                    html = '<div class="loading">No market data available</div>';
                }
                
                marketOverviewGrid.innerHTML = html;
            } catch (error) {
                console.error('Error loading market overview:', error);
                marketOverviewGrid.innerHTML = '<div class="loading">Error loading market overview. Please try again.</div>';
            }
        }
        
        // Make removeFromWatchlist available globally for onclick
        window.removeFromWatchlist = removeFromWatchlist;
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>